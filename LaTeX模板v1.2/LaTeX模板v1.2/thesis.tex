%%]dvipdfm
\documentclass[oneside, master, review]{NJUthesis}
%\documentclass[twoside, master]{NJUthesis}

% 可选参数：
%   review 审阅模式，激活后个人、导师与学校信息均被隐去
%   oneside/twoside 单面/双面打印
%   phd/master 博士/硕士论文
% 下面三个选一个：
% dvi2pdf 使用 dvi2pdf(x) 生成最终的 PDF 文档 (缺省设置，不建议修改）
% dvips 使用 dvips 生成最终的 PS 文档
% pdftex 使用 pdfLaTeX 生成最终的 PDF 文档

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 导言区
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 小节标题靠左对齐
\CTEXsetup[format+={\flushleft}]{section}

% 设置链接颜色
\hypersetup{
% pdf 属性
             pdftitle={LaTeX Thesis Template of Nanjing University}, %
            pdfauthor={San Zhang}
}

% 表格
\usepackage{longtable, multirow}
% 英文使用 Times 字体
\usepackage{times}
% 源代码
\usepackage{fancyvrb}
% 自定义列表样式
\usepackage{enumitem}
\usepackage{url}

\def\UrlBreaks{\do\/\do-}
\usepackage{breakurl}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{moreverb}
\usepackage{txfonts}
\usepackage{mathcomp}
\usepackage{graphicx}
\usepackage{subfigure}
\usepackage[linesnumbered,boxed,ruled,vlined]{algorithm2e}
\usepackage{array}
\usepackage{multirow}

%%	added by Jiang
\usepackage{extarrows}	%使用长箭头
\usepackage{nomencl}	%与术语表有关的包
\usepackage{booktabs}
\usepackage{ccmap}
\usepackage{float}


\makenomenclature

\setcounter{topnumber}{5}
\Urlmuskip=0mu plus 1mu

\theoremstyle{plain}
\newtheorem{definition}{\hspace{2em}定义}[chapter]
\newtheorem{lemma}{\hspace{2em}引理}[chapter]
\newtheorem{theorem}{\hspace{2em}定理}[chapter]
\newtheorem{property}{\hspace{2em}性质}[chapter]
\newtheorem{example}{\hspace{2em}例}[chapter]
\newtheorem{myrule}{\hspace{2em}规则}[chapter]


\newcommand{\tabincell}[2]{\begin{tabular}{@{}#1@{}}#2\end{tabular}}% 表格内换行
\renewcommand{\footnoterule}{%脚注线
  \kern -3pt
  \hrule width 2.3in height 0.4pt
  \kern 2pt
}


\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 封面部分
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 国家图书馆封面内容字符串
% 仅博士需要填写并保证模板参数选择了 phd
\classification{}
\confidential{}
\UDC{}
\titlelinea{南京大学学位论文}
\titlelineb{~\LaTeX{}~模板}
\titlelinec{}
\advisorinfo{南京大学~软件学院}
\chairman{XXX 教授}
\reviewera{某某某某　副研究员}
\reviewerb{XXX 教授}
\reviewerc{XXX 教授}
\reviewerd{XXX 教授}
\nlcfootdate{~年~~月~~日}

% 南大中文封面内容字符串
\title{图数据库StellarDB存储模块性能优化的设计与实现}
\author{\kaishu 徐江河}
\studentnum{-}
\grade{2018}
\advisor{\kaishu 邵栋~~教授}

\major{\kaishu 工程硕士（软件工程领域）}
\researchfield{\kaishu 软件工程}
\footdate{\kaishu2020~年~2~月}
\submitdate{\kaishu2020~年~2~月~27~日}
\defenddate{\kaishu20xx~年~x~月~xx~日}



% 英文封面内容字符串
\englishtitle{The Design and Implementation of Performance Optimization on Storage Module of StellarDB}
\englishauthor{Jianghe Xu}
\englishadvisor{Advisor Title}
\englishadvisorname{~~Dong Shao}
\englishinstitute{Software Institute}
\englishdegree{Master of Engineering}
\englishmajor{Software Engineering}
\englishdate{Feb 2020}

% 制作封面命令
\maketitle

%\makechinesetitle

% 制作英文封面命令
\makeenglishtitle


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 前言部分
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\frontmatter

\begin{abstract}

今天，图数据库由于其在现实生产生活场景中的建模优势、在关系查找方面的性能优势，成为越来越重要的基础软件。国内外许多软件厂商都推出了自己的图数据库产品。StellarDB是星环公司的图数据库，可以与其他组件配合，实现图存储、图分析、图可视化等重要功能。StellarDB存储引擎采用日志结构合并树（Log-Structured Merge-Tree，下称LSM树）数据结构作为底层数据存储方式。

但是，在实际部署过程中，StellarDB遭遇了严重的性能的问题。在进行大数据集高并发写入之后，StellarDB性能急剧下降。虽然数据库节点还处于活跃状态，但客户端发出查询请求之后，无法在预期时间内接收到回复。原定的响应超时时间为30秒，但此时的StellarDB实际需要数分钟才能返回查询结果。

本文介绍了对问题的分析过程：通过对性能数据的观察，可以看到数据堆积在LSM树的最顶层，向下流动速度极慢，导致读请求搜索数据条目主键的时候需要访问多达上千个数据文件，从而使系统无法在预期时间内回复。这是因为在数据流动过程中，由于LSM树结构本身的固有维护方式，存在大量对旧数据的重新读写，造成了磁盘读写的浪费。而此情景下磁盘已经发挥最大读写速度，所以需要提升对磁盘读写的利用效率，减少浪费。

据此思路，本文实现了减少读写浪费的优化方案。首先，通过修改flush算法对内存缓冲区进行强制分片，优化文件中的数据分布，使得单个L0数据文件主键范围缩小，方便compaction调度。其次，实现更精细compaction算法，根据下层数据文件的主键范围选择尽量多的上层数据文件，并计算I/O浪费最低的方案，能降低compaction过程中的磁盘I/O浪费，加速数据在LSM树向下流动。
本文详细说明了对flush算法与compaction算法的联合创新性优化方案的设计与实现，并展示了优化过程中的多次性能测试结果，从中解释算法逐步优化的根据与效果。另外，本文通过对StellarDB的存储模块进行抽象简化，实现了一个存储模块模拟程序，用于再次测试、验证优化算法的有效性。

最终测试结果显示，从L0到L1的compaction读扩大率从419\%下降至119\%，数据不再堆积于顶层，各层compaction过程顺畅，数据能够较快流动到底层。
经过优化，StellarDB在高并发大数据集写入情景下的性能问题已经解决，系统能够及时正常响应读请求。目前优化后算法已经在StellarDB中运行，性能稳定。
  

%这是注释，不影响正文

\keywords{图数据库，StellarDB，日志结构合并树，Flush，Compaction}

\end{abstract}

% 英文摘要
\begin{englishabstract}
Nowadays, graph database is becoming more and more popular because of its advantage in modeling real life and performance advantage in relationship search. Many software companys, countrywide or worldwide, are building their own graph database systems. StellarDB is the graph storage engine of Transwarp Inc. Combined with other Transwarp products, it can support various big data analysis requirements, including graph storage, graph analysis, graph visualization, etc.. StellarDB storage engine adopted Log-Structured Merge-Tree(i.e. LSM-tree) as its underlying data structure for record storage.

However, during deployment and tests on clients' hosts, severe performance issues were encountered that read requests timeouted after high concurrency write operation. StellarDB client couldn't receive response for search requests even if all database servers were active. It could take several minutes for StellarDB to produce a valid response, while the default request timeout was 30 seconds.

The thesis introduces the analyze process on the issue and the design and implementation of a combined innovative optimization on flush algorithm and compaction algorithm. 
According to performance metrics, the data couldn't flow into lower levels of the LSM-tree, causing the system to scan over one thousand data files just for searching one record's key. Therefore, StellarDB failed to respond to read requests within default read timeout. 
Due to the data structure of LSM-tree, large amount of disk read and write for the old data exists during the flow of data, which caused much disk I/O waste. Considering that the disk I/O was already at full speed in the problem, it's improving the I/O efficiency that can help with speeding up the data flow. 

With this method, the thesis implemented the following optimization. Firstly, the new flush algorithm forces memory buffer to be sliced,  making the record key range of data files in L0 become narrow. By optimizing files' data distribution, scheduling compaction tasks became easier. Secondly, the new compaction algorithm can choose files in upper level basing on lower level key range and calculate the compaction schedule plan with least I/O waste. 
Then the thesis demostrated results of performance test during the optimization process, explaining the evidences on which the optimization was based. Moreover, the thesis implemented an simulator of the storage module for more testing and verification of the influence of the new algorithms.

The results of the performance test showed that the read amplification rate of compaction from L0 to L1 dropped from 419\% to 119\%. Data no longer piled up in L0 and could flow into lower levels without difficulty.
After this optimization, the performance bottleneck of StellarDB performing compaction under high concurrency write operation was successfully solved, allowing the system to respond to read requests in time. The optimized algorithm has been running in deployed StellarDB instances with steady performance.


\englishkeywords{Graph database, StellarDB, Log-Structured Merge-Tree, Flush, Compaction}
\end{englishabstract}

% 生成目录命令（目录中不包含目录本身）
\addtocontents{toc}{\protect\setcounter{tocdepth}{-1}}
\tableofcontents
\addtocontents{toc}{\protect\setcounter{tocdepth}{2}}


% 以下两个目录可根据具体情况注释掉（将表格目录和图形目录重命名后加入目录）
% 生成表格目录命令
\renewcommand*{\listtablename}{表~~目~~录}
\listoftables
\addcontentsline{toc}{chapter}{表~~目~~录}
% 生成插图目录命令
\renewcommand*{\listtablename}{图~~目~~录}
\listoffigures
\addcontentsline{toc}{chapter}{图~~目~~录}

%生成术语表命令
%\include{chapter/Nomenclatures}
%\def\nomname{缩略语对照表}
%\printnomenclature[5em]
\hyphenation{mem-table Mem-table Graph-Shard trans-warp graph-search com-pac-tion Com-pac-tion Com-pac-tion-Hand-ler Com-pac-tion-Exe-cutor Flush-Handler Flush-Executor Elastic-Search Janus-Graph}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 正文部分
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\mainmatter
\input{chapter/c1.tex}
\input{chapter/c2.tex}
\input{chapter/c3.tex}
\input{chapter/c4.tex}
\input{chapter/c5.tex}

% 参考文献

\bibliography{reference}



%个人简介
% \Nchapter{简历与科研成果}
% \noindent {\heiti 基本情况}
% \vspace{1ex}
% \noindent 徐江河，男，汉族，1996~年~3~月出生，山东省淄博市人。
% \vspace{2ex}

% \noindent {\heiti 教育背景}
% \begin{description}[labelindent=0em, leftmargin=8em, style=sameline]
% \item[2018.9～2020.6] 南京大学软件学院 \hfill 硕士
% \item[2014.9～2018.7] 南京大学软件学院 \hfill 本科
% \end{description}
% 发表文章目录


\backmatter


\begin{thanks}

\vskip 18pt

% 在本篇论文完成之际，也就意味着我在南京大学软件学院的学习生涯也将要结束了。我要向曾经帮助过我的导师、同学和朋友致以最诚挚的感谢。首先要感谢我的论文指导老师邵栋老师。在整个论文写作的过程中，邵老师对我耐心帮助，在论文不足之处他总是及时耐心地提出修改和优化的建议。每一次和邵老师交谈，我都能感受到邵老师作为师长的责任与担当。邵老师对待学术严谨的态度和平易近人的生活作风深深的影响着我，使我受益终身。


% 同时，我要感谢实习期间给予我帮助的"buddy"王志平和公司给予我帮助的所有同事们。他们在项目完成和技术指导上给了我很大的帮助，感谢他们在忙于工作的同时还能抽出时间对我进行指导。这段经历，我相信在我以后的工作生活中一定会有很大的借鉴意义。

% 最后我要感谢南京大学软件学院和南京大学软件学院所有的教职工人员。是他们为能来到南京软件学院读研的同学们提供了一个开放的包容的成长环境，他们高远的学术视野和严谨的工作作风深深的影响着每一个南京大学软件学院的学子们。在南京读硕士的这两年，让我对自己的认识更清晰，对自己的未来更有信心。谢谢大家！

\end{thanks}


\end{document}


