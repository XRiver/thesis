\chapter{总结与展望}

\section{总结}

大数据时代对数据库性能提出了很高的要求。数据库在承载较高的写入负载的同时，也需要提供充足的查询性能。本文介绍了对星环科技StellarDB的存储模块性能的优化行为，主要进行了以下工作：

\begin{enumerate}
  \item 介绍StellarDB存储模块的所用到的核心技术，包括LSM树数据结构与Raft一致性协议，并说明了这些技术在StellarDB种所起到的作用。
  \item 解释了对StellarDB存储模块的概略设计与它对LSM树的实现、维护方法。这为后文说明算法优化的设计提供了基础。
  \item 说明了性能问题在StellarDB的具体业务表现，并对其进行深度分析。在实际业务应用中，StellarDB经过大数据集高并发写入后，无法在超时时间内完成查询请求的处理。性能瓶颈被定位在L0的compaction过程。由于对磁盘I/O的利用效率太低，有限的磁盘读写速度无法满足系统需要。所以需要减少I/O浪费。
  \item 详细描述了算法的优化过程，包括在性能测试过程中对算法的逐步完善。最终通过在flush算法加入强制分片，在compaction算法对分片针对性优化调度方式，将读扩大率从419\%降低至119\%，消除了数据文件堆积，成功解决了业务上的性能问题。
  \item 最后通过实现一个优化算法模拟程序，进一步证明了优化算法有效性。
\end{enumerate}

经过对flush算法与compaction算法的联合优化，StellarDB的读超时的性能问题得到了解决。在优化结束后，本文总结了以下算法优化经验：

\begin{enumerate}
    \item 本文介绍的compaction算法是通过对最初的“读请求响应超时问题”反复测试、仔细分析后，发现性能瓶颈从而针对性能瓶颈做优化而得到的。这个过程中，离不开本人预先对StellarDB系统的性能监测功能的完善。所以，处理性能优化问题时，需要重视系统的性能统计功能。如果现有的统计能力不能满足问题分析的需求，则应当现场开发统计功能。
    \item “通过分割Memtable给compaction降低读扩大率提供条件”的方案看起来并不直接，像是一种“曲线救国”，但实际上也是根据“读扩大率过高导致大量浪费的I/O”这一现象层层推导得到：为了节省I/O，降低读扩大率，就要减少compaction任务中对L1文件的使用，增加对L0文件的使用。但在随机写入的环境下，现有的flush策略使得所有L1文件都会被使用，所以要先修改flush策略，使调度仅包含少量L1文件的compaction任务变成可能。所以在flush的时候就要控制单个L0文件的主键范围。优化性能需要用逻辑推导解决方案，并做好推翻一些看似理所应当的设计的准备，这样才能发现创新性的解决方案。
    \item 性能优化最终要回归性能数据才有说服力。这次写入性能优化除了compaction算法，实际上还包含了许多参数调节，伴随着多次额外的对比性能测试。这些没有在本文中提及。正是详实的性能数据才能证明优化的有效性。尤其是调参带来的性能变化的数据，对于系统部署时的性能调优有重大参考意义。
  \end{enumerate}

\section{展望}

本文所介绍的优化算法已经完成开发、测试，在StellarDB的稳定版本内发挥作用。客户的使用反馈证实了此优化确实解决了之前的高并发写入后无法进行读请求的问题。但是对于LSM树写入维护的优化工作并未停止。本优化中的“L0与L1文件选取顺序倒置”的方法应当也可以应用于更底层的compaction过程，从而在底层也实现降低读扩大率的效果。进行性能测试的过程中，有时会出现下层compaction或最底层文件互相合并的操作造成大量I/O浪费的情况，虽然不会对读请求处理产生显著影响，但也是未来优化的方向。